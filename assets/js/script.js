//default map position
let map = L.map('map').setView([40, -95], 4);
map.doubleClickZoom.disable();
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

//marker pins
const breweryIcon = {
    iconUrl: './assets/js/Brewery.png',
    iconSize: [40, 50]
}

const locationsIcon = {
    iconUrl: './assets/js/ClearBrew.png',
    iconSize: [50, 60]
}

const searchIcon = L.icon(locationsIcon)
const beerIcon = L.icon(breweryIcon)

const breweryOptions = {
    icon: beerIcon
}

const searchOptions = {
    icon: searchIcon
}

let breweryResults = []

//uses the opencagedata api to search a set, grabs the latitude and longitude of the city to display breweries in the area
function searchCity() {
    cityGroup.clearLayers()
    let city = document.getElementById('cityInput').value;
    fetch(`https://api.opencagedata.com/geocode/v1/json?q=${city}&key=bbb05a8edb664fc99f7958790b747fa8`)
        .then(response => response.json())
        .then(data => {
            let lat = data.results[0].geometry.lat;
            let lng = data.results[0].geometry.lng;
            marker = L.marker([lat, lng], searchOptions).addTo(cityGroup);
            marker.city = city
            marker.on('click', onMarkerToggle)
            map.setView([lat, lng], 10);
            const localBrew = `https://api.openbrewerydb.org/v1/breweries/?by_dist=${lat},${lng}&per_page=10`
            fetch(localBrew)
                .then(response => response.json())
                .then(function (data) {
                    displayBreweries(data)
                    breweryResults = data
                    console.log(cityGroup)
                    console.log(breweryResults)
                })
            // filter results form breweryResults, replot old results
        })
        .catch(error => {
            console.error('Error:', error);
        });
}
//calls the displayBrew function per item in the array
function displayBreweries(breweries) {
    layerGroup.clearLayers()
    for (let i = 0; i < breweries.length; i++) {
        displayBrew(breweries[i])
    }
}

//plots the brewery from the data returned by the localBrew fetch request
function displayBrew(data) {
    map.closePopup();
    marker = L.marker([data.latitude, data.longitude], breweryOptions).addTo(layerGroup) //insert coords
    marker.bindPopup(`<p>${data.name}<br /> ${data.brewery_type} <br /> ${data.phone}</p>`).openPopup
}

//once you click the marker generated by the searchCity function shows or hides the results
function onMarkerToggle() {
    if (layerGroup.getLayers().length === 0) {
        displayBreweries(breweryResults)
    } else {
        layerGroup.clearLayers();
    }
}

//event listener for clicking map
map.on('click', onMapClick);
//define a popup
let popup = L.popup()

function onMapClick(e) {
    //add content to the popup when clicked
    popup
        .setLatLng(e.latlng)
        .setContent('<p> Get started by searching a city or <br /> click on a beer for info about the Brewery!</p>')
        .openOn(map)
}

let layerGroup = L.markerClusterGroup().addTo(map)
let cityGroup = L.layerGroup().addTo(map)



$('form').on('submit', function (event) {
    event.preventDefault();
    layerGroup.clearLayers();
    getAndSetBreweryLocation();
})

// Get the modal
let modal = document.getElementById("myModal");

// Get the button that opens the modal
let btn = document.getElementById("myBtn");

// Get the <span> element that closes the modal
let span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal 
btn.onclick = function () {
    modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function () {
    modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function (event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

const viewToggle = document.querySelector('#view-toggle')

let darkMode = localStorage.getItem("view-toggle")

const enableDarkMode = () => {
    document.body.classList.add('darkmode');
    localStorage.setItem('view-toggle', 'enabled');
}

if (darkMode === 'enabled') {
    enableDarkMode();
}

const disableDarkMode = () => {
    document.body.classList.remove('darkmode');
    localStorage.setItem('view-toggle', null);
}

viewToggle.addEventListener('click', function (event) {
    darkMode = localStorage.getItem("view-toggle")
    if (darkMode !== 'enabled') {
        enableDarkMode();
        console.log(darkMode)
    } else {
        disableDarkMode();
        console.log(darkMode)
    }
});

